<!DOCTYPE html>
<html style="height: 100%; margin: 0">

<head>
    <title>OSRS F2P Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="scripts/leaflet.css"/>
    <script src="scripts/leaflet.js"></script>
</head>

<body style="height: 100%;margin: 0">
    <div id="map" style="height: 100%; height: 98%; background: #000000; margin: 0"></div>
    <div id="coordinates"></div>
    <script type="text/javascript">

        // Image dimensions at maximum zoom (pixels/32) (x,y)
        var xMax = 3136;
            yMax = 11392;
        var boundPad = 500;
        var imageNW = [0, 0];
            imageNE = [xMax, 0];
            imageSW = [0, yMax];
            imageSE = [xMax, yMax];

        // Wrapper converting LongLat(x,y)[brain coords] to LatLong(y,x)[leaflet coords] for ease
        var yx = function(x, y) {
            // If the input is an array
            if (L.Util.isArray(x)) {
                return ([x[1], x[0]]);
            }
            // If the input is a tuple
            return (y,x);
        }

        // Wrapper converting LongLat(x,y)[brain coords] to LatLong(y,x)[leaflet coords] for ease
        // Useful for markers
        var tileCenter = function(x,y) {
            // If the input is an array
            if (L.Util.isArray(x)) {
                return ([x[0]+0.5, x[1]+0.5]);
            }
            // If the input is a tuple
            return (x+0.5,y+0.5);
        }

        // Convert from LongLat(x,y) to OSRS game coordinate system
        // This is just a shifting transformation
        var gameCoordinate = function(x,y) {
            // If the input is an array
            if (L.Util.isArray(x)) {
                return ([x[0]+1152, yMax-x[1]+1215]);
            }
            // If the input is a tuple
            return [x+1152, yMax-y+1215]
        }

        // Custom CRS
        // 8 game units per tile at Zoom 11 -> 256/8 = 64
        L.CRS.myCRS = L.extend({}, L.CRS.Simple, {
            transformation: new L.Transformation(1/64, 0, 1/64, 0),
        });

        // Insert a map container
        var map = L.map('map', {
            crs: L.CRS.myCRS,
            center: [0,0],
            zoom: 4,
            minZoom: 1,
            maxZoom: 11,
        })

        // Set map boundaries and prevent user scrolling beyond them 
        console.log(yx([imageNW[0]-boundPad,imageNW[1]-boundPad]))
        var bounds = new L.latLngBounds(
            yx([imageNW[0]-boundPad,imageNW[1]-boundPad]), 
            yx([imageSE[0]+boundPad,imageSE[1]+boundPad]),
        )
        map.setMaxBounds(bounds)

        // Place tiles
        var tiles = L.tileLayer('own_dzsave/{z}/0/{y}/{x}.png', {
            minZoom: 1,
            maxZoom: 11,
        }).addTo(map);

        // Grid debugger
        L.GridLayer.DebugCoords = L.GridLayer.extend({
            createTile: function (coords) {
                var tile = document.createElement('div');
                tile.innerHTML = [coords.x, coords.y, coords.z].join(', ');
                tile.style.outline = '1px solid red';
                tile.style.color = 'white';
                return tile;
            }
        });

        L.gridLayer.debugCoords = function(opts) {
            return new L.GridLayer.DebugCoords(opts);
        };

        map.addLayer(L.gridLayer.debugCoords({
            // bounds: [[0, 0], [imageSize - 1, imageSize - 1]]
        }));

        // Displays Pixel coordinates and latlng (in CRS.Simple latlng === game tile coordinates)
        map.on('mousemove', function(event) {
            var coords = event.latlng;
            document.getElementById('coordinates').innerHTML = 'Px: ' + map.project(coords) + ' x = ' + Math.floor(coords.lng) + ', y = ' + Math.floor(coords.lat) 
            + ' // Game Coordinates:' + gameCoordinate([Math.floor(coords.lng), Math.floor(coords.lat)]);
        });

        var marker = L.marker(tileCenter(yx([1885,9235]))).addTo(map);
        marker.bindPopup('<b>fally ref: <b>' + gameCoordinate([1885,9235])).openPopup();

        var marker = L.marker(tileCenter(yx([1939,9119]))).addTo(map);
        marker.bindPopup('<b>edge ref: <b>' + gameCoordinate([1939,9119])).openPopup();

        var marker = L.marker(tileCenter(yx([1457,9519]))).addTo(map);
        marker.bindPopup('<b>yanille ref: <b>' + gameCoordinate([1457,9519])).openPopup();

        var marker = L.marker(tileCenter(yx(imageNW))).addTo(map);
        marker.bindPopup('<b>NW<b>').openPopup();

        var marker = L.marker(tileCenter(yx(imageNE))).addTo(map);
        marker.bindPopup('<b>NE<b>').openPopup();

        var marker = L.marker(tileCenter(yx(imageSW))).addTo(map);
        marker.bindPopup('<b>SW<b>').openPopup();
        
        var marker = L.marker(tileCenter(yx(imageSE))).addTo(map);
        marker.bindPopup('<b>SE<b>').openPopup();

        // L.rectangle([yx(imageSE), yx(imageNW)], {color: "#ff7800", weight: 1}).addTo(map);

        // TODO: clean up repo
        // TODO: clean up the tile generator
        // TODO: labels
        // TODO: floating coordinate display
        // TODO: json ingest
    </script>
</body>

</html>